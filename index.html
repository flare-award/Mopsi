// –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ (–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø - –∏–¥–µ–Ω—Ç–∏—á–Ω–æ –±–æ—Ç—É)
function restoreEnergyBasedOnTime(userData) {
    try {
        const now = new Date();
        const lastUpdateStr = userData.last_energy_update;
        
        if (!lastUpdateStr) {
            return {
                ...userData,
                last_energy_update: now.toISOString()
            };
        }
        
        const lastUpdate = new Date(lastUpdateStr);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
        if (isNaN(lastUpdate.getTime())) {
            console.warn('–ù–µ–≤–µ—Ä–Ω–∞—è –¥–∞—Ç–∞ last_energy_update, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º');
            return {
                ...userData,
                last_energy_update: now.toISOString()
            };
        }
        
        const timeDiff = (now - lastUpdate) / 1000; // –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø—Ä–æ—à–ª–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –≤—Ä–µ–º–µ–Ω–∏
        if (timeDiff > 0) {
            const energyRegenSpeed = userData.energy_regen_speed || 10;
            const currentEnergy = userData.energy || 0;
            const maxEnergy = userData.max_energy || 100;
            
            // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–Ω–µ—Ä–≥–∏–∏ –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)
            const energyToAdd = Math.floor(timeDiff / energyRegenSpeed);
            
            if (energyToAdd > 0) {
                const newEnergy = Math.min(maxEnergy, currentEnergy + energyToAdd);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
                if (newEnergy !== currentEnergy) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ù–û–ô —ç–Ω–µ—Ä–≥–∏–∏
                    const actualSecondsUsed = energyToAdd * energyRegenSpeed;
                    const newLastUpdate = new Date(lastUpdate.getTime() + actualSecondsUsed * 1000);
                    
                    console.log(`‚ö° –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ ${energyToAdd} —ç–Ω–µ—Ä–≥–∏–∏. –¢–µ–ø–µ—Ä—å: ${newEnergy}/${maxEnergy}`);
                    
                    return {
                        ...userData,
                        energy: newEnergy,
                        last_energy_update: newLastUpdate.toISOString()
                    };
                }
            }
        }
        return userData;
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏:', error);
        return userData;
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —ç–Ω–µ—Ä–≥–∏–∏ (–¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)
async function restoreEnergy() {
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ –ø–æ–ª–Ω–∞—è
    if (userData.energy < userData.max_energy) {
        const oldEnergy = userData.energy;
        userData = restoreEnergyBasedOnTime(userData);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç–Ω–µ—Ä–≥–∏—è –∏–∑–º–µ–Ω–∏–ª–∞—Å—å
        if (userData.energy !== oldEnergy) {
            updateDisplay();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
            if (Math.random() < 0.03) {
                await saveUserData();
            }
        }
    }
}

// –í —Ñ—É–Ω–∫—Ü–∏–∏ handleTap –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ–±–Ω–æ–≤–ª—è–µ–º last_energy_update –ø—Ä–∏ —Ç—Ä–∞—Ç–µ —ç–Ω–µ—Ä–≥–∏–∏
async function handleTap(event) {
    if (userData.energy >= 1) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º
        userData = restoreEnergyBasedOnTime(userData);
        
        // –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞—Ä–∞–±–æ—Ç–æ–∫
        let earned = userData.per_tap;
        userData.coins += earned;
        userData.energy--;
        userData.total_taps++;
        userData.last_tap_time = new Date().toISOString();
        
        // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –æ–±–Ω–æ–≤–ª—è–µ–º last_energy_update –ø—Ä–∏ —Ç—Ä–∞—Ç–µ —ç–Ω–µ—Ä–≥–∏–∏
        userData.last_energy_update = new Date().toISOString();
        
        // –°–æ–∑–¥–∞–µ–º —ç—Ñ—Ñ–µ–∫—Ç —Ç–∞–ø–∞
        createTapEffect(event, `+${earned} üíé`);
        
        // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —É–¥–∞—Ä
        let critChance = 5 + (userData.upgrades.critical_chance || 0) * 0.5;
        if (Math.random() < critChance / 100) {
            let critMultiplier = 2 + (userData.upgrades.critical_multiplier || 0) * 0.1;
            let critBonus = Math.floor(earned * critMultiplier);
            userData.coins += critBonus;
            createTapEffect(event, `üí• –ö–†–ò–¢! +${critBonus}`);
        }
        
        // –°–ª—É—á–∞–π–Ω—ã–π –±–æ–Ω—É—Å
        if (Math.random() < 0.1) {
            const bonus = Math.floor(Math.random() * 5 + 1) * userData.per_tap;
            userData.coins += bonus;
            createTapEffect(event, `üéâ +${bonus}!`);
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω—è
        const newLevel = Math.floor(userData.coins / 1000) + 1;
        if (newLevel > userData.level) {
            userData.level = newLevel;
            showLevelUp();
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫–∏–Ω–æ–≤
        checkSkinUnlocks();
        
        updateDisplay();
        await saveUserData();
    } else {
        showNotification('–≠–Ω–µ—Ä–≥–∏—è –∑–∞–∫–æ–Ω—á–∏–ª–∞—Å—å. –ü–æ–¥–æ–∂–¥–∏ –Ω–µ–º–Ω–æ–≥–æ!', 'error');
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
async function loadUserData() {
    try {
        console.log('üîç –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
        const response = await fetch(JSONBIN_URL, {
            headers: {
                "X-Master-Key": JSONBIN_API_KEY
            }
        });
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        }
        
        const data = await response.json();
        const users = data.record.users || {};
        
        if (users[userId]) {
            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ');
            let savedData = users[userId];
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—Ä–µ–º–µ–Ω–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é)
            savedData = restoreEnergyBasedOnTime(savedData);
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º upgrades –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ –æ–±—ä–µ–∫—Ç –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
            if (typeof savedData.upgrades === 'string') {
                try {
                    savedData.upgrades = JSON.parse(savedData.upgrades);
                } catch (e) {
                    savedData.upgrades = {};
                }
            }
            
            userData = { ...userData, ...savedData };
            
            console.log('üìä –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', {
                coins: userData.coins,
                energy: userData.energy,
                max_energy: userData.max_energy,
                last_energy_update: userData.last_energy_update,
                energy_regen_speed: userData.energy_regen_speed
            });
            
        } else {
            console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ');
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await saveUserData();
        }
        
        updateDisplay();
        applySettings();
        document.getElementById('loading-overlay').style.display = 'none';
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        document.getElementById('loading-overlay').style.display = 'none';
        showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è.', 'error');
    }
}

// –£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
async function saveUserData() {
    try {
        console.log('üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...');
        
        // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
        const response = await fetch(JSONBIN_URL, {
            headers: {
                "X-Master-Key": JSONBIN_API_KEY
            }
        });
        
        if (!response.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${response.status}`);
        }
        
        const data = await response.json();
        const users = data.record.users || {};
        
        // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–∏–¥–µ–Ω—Ç–∏—á–Ω–æ –±–æ—Ç—É)
        const userDataToSave = {
            username: userData.username || `user_${userId}`,
            coins: userData.coins || 0,
            per_tap: userData.per_tap || 1,
            energy: userData.energy || 100,
            max_energy: userData.max_energy || 100,
            energy_regen_speed: userData.energy_regen_speed || 10,
            last_tap_time: userData.last_tap_time || new Date().toISOString(),
            level: userData.level || 1,
            total_taps: userData.total_taps || 0,
            last_energy_update: userData.last_energy_update || new Date().toISOString(),
            upgrades: JSON.stringify(userData.upgrades || {}),
            referrals_count: userData.referrals_count || 0,
            referral_bonus_claimed: userData.referral_bonus_claimed || false,
            referrer_id: userData.referrer_id || null,
            clan_id: userData.clan_id || null,
            pug_skin: userData.pug_skin || 1,
            created_at: userData.created_at || new Date().toISOString(),
            settings: userData.settings || {
                sound: true,
                vibration: true,
                darkMode: false,
                notifications: true
            }
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        users[userId] = userDataToSave;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—Ä–∞—Ç–Ω–æ
        const updateResponse = await fetch(JSONBIN_UPDATE_URL, {
            method: 'PUT',
            headers: {
                "X-Master-Key": JSONBIN_API_KEY,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                ...data.record,
                users: users
            })
        });
        
        if (!updateResponse.ok) {
            throw new Error(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${updateResponse.status}`);
        }
        
        console.log('‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
        
    } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö:', error);
        showNotification('–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω–æ. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏.', 'error');
    }
}

// –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–≤—Ç–æ-—Ç–∞–ø–ø–µ—Ä
setInterval(async () => {
    const autoTapperLevel = userData.upgrades.auto_tapper || 0;
    if (autoTapperLevel > 0 && userData.energy > 0) {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç–Ω–µ—Ä–≥–∏—é –ø–µ—Ä–µ–¥ –¥–µ–π—Å—Ç–≤–∏–µ–º
        userData = restoreEnergyBasedOnTime(userData);
        
        for (let i = 0; i < autoTapperLevel; i++) {
            if (userData.energy > 0) {
                userData.coins += userData.per_tap;
                userData.energy--;
                userData.total_taps++;
                
                // –û–ë–ù–û–í–õ–Ø–ï–ú last_energy_update –ø—Ä–∏ —Ç—Ä–∞—Ç–µ —ç–Ω–µ—Ä–≥–∏–∏ –∞–≤—Ç–æ-—Ç–∞–ø–ø–µ—Ä–æ–º
                userData.last_energy_update = new Date().toISOString();
            }
        }
        updateDisplay();
        await saveUserData();
    }
}, 10000);
